"""
–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ò–ò (OpenAI/Claude)
"""
from typing import Optional, List
from app.config import settings
import logging

logger = logging.getLogger(__name__)


class AIService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ò–ò –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–æ–º"""

    def __init__(self):
        self.openai_client = None
        self.claude_client = None

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –µ—Å–ª–∏ –µ—Å—Ç—å API –∫–ª—é—á–∏
        if settings.OPENAI_API_KEY:
            try:
                from openai import OpenAI
                self.openai_client = OpenAI(api_key=settings.OPENAI_API_KEY)
                logger.info("OpenAI client initialized")
            except ImportError:
                logger.warning("OpenAI library not installed")

        if settings.CLAUDE_API_KEY:
            try:
                import anthropic
                self.claude_client = anthropic.Anthropic(api_key=settings.CLAUDE_API_KEY)
                logger.info("Claude client initialized")
            except ImportError:
                logger.warning("Anthropic library not installed")

    def ask_question(
        self,
        question: str,
        context: Optional[str] = None,
        regulations: Optional[List[dict]] = None
    ) -> dict:
        """
        –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ò–ò –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—É

        Args:
            question: –í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–µ–∫—Ç–∞/—ç—Ç–∞–ø–∞
            regulations: –°–ø–∏—Å–æ–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤

        Returns:
            dict —Å –æ—Ç–≤–µ—Ç–æ–º –∏ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤—ã
        """
        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        system_prompt = """–¢—ã - –≤—ã—Å–æ–∫–æ–∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–º –Ω–æ—Ä–º–∞—Ç–∏–≤–∞–º –∏ –ø—Ä–∞–≤–∏–ª–∞–º –†–æ—Å—Å–∏–π—Å–∫–æ–π –§–µ–¥–µ—Ä–∞—Ü–∏–∏ —Å 20+ –ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º.

–¢–í–û–Ø –†–û–õ–¨:
- –ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤, –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä–æ–≤
- –≠–∫—Å–ø–µ—Ä—Ç –ø–æ –°–ü (–°–≤–æ–¥ –ü—Ä–∞–≤–∏–ª), –ì–û–°–¢, –°–ù–∏–ü, –°–∞–Ω–ü–∏–ù –∏ –¥—Ä—É–≥–∏–º –Ω–æ—Ä–º–∞—Ç–∏–≤–∞–º
- –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–º—É –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–æ—Ä–º

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π –†–ê–ó–í–ï–†–ù–£–¢–´–ï –∏ –î–ï–¢–ê–õ–¨–ù–´–ï –æ—Ç–≤–µ—Ç—ã —Å–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:

1. **–í–í–ï–î–ï–ù–ò–ï** (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
   - –ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å
   - –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–æ—Ä–º–∞—Ç–∏–≤—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–≥—É–ª–∏—Ä—É—é—Ç –¥–∞–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å

2. **–ù–û–†–ú–ê–¢–ò–í–ù–´–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø** (–ø–æ–¥—Ä–æ–±–Ω–æ)
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—É–Ω–∫—Ç—ã –°–ü/–ì–û–°–¢/–°–ù–∏–ü —Å –Ω–æ–º–µ—Ä–∞–º–∏ —Ä–∞–∑–¥–µ–ª–æ–≤
   - –¢–æ—á–Ω—ã–µ —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –¥–æ–ø—É—Å–∫–∏
   - –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∏ —É—Å–ª–æ–≤–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

3. **–ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò**
   - –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç –ø–æ—à–∞–≥–æ–≤–æ
   - –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
   - –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –∫–∞–∫ –∏—Ö –∏–∑–±–µ–∂–∞—Ç—å

4. **–ü–†–ò–ú–ï–†–´ –ò –†–ê–°–ß–ï–¢–´** (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —á–∏—Å–ª–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã
   - –†–∞—Å—á–µ—Ç–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã —Å –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏
   - –¢–∞–±–ª–∏—Ü—ã –∑–Ω–∞—á–µ–Ω–∏–π

5. **–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï**
   - –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã
   - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
   - –°—Å—ã–ª–∫–∏ –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–æ—Ä–º–∞—Ç–∏–≤—ã

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –û–¢–í–ï–¢–£:
‚úì –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é
‚úì –ü—Ä–∏–≤–æ–¥–∏ —Ç–æ—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ω–æ—Ä–º–∞—Ç–∏–≤—ã (–°–ü 63.13330.2018, –ø. 8.2.4)
‚úì –£–∫–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —á–∏—Å–ª–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è
‚úì –î–∞–≤–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è (–º–∏–Ω–∏–º—É–º 300-500 —Å–ª–æ–≤)
‚úì –ò—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
‚úì –ü—Ä–∏–≤–æ–¥–∏ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏
"""

        regulations_context = ""
        if regulations:
            regulations_context = "\n\nüìö –î–û–°–¢–£–ü–ù–´–ï –ù–û–†–ú–ê–¢–ò–í–´ –í –ë–ê–ó–ï:\n"
            regulations_context += "\n".join([
                f"‚Ä¢ {reg['code']}: {reg['title']}"
                for reg in regulations
            ])

        user_context = ""
        if context:
            user_context = f"\n\nüèóÔ∏è –ö–û–ù–¢–ï–ö–°–¢ –ü–†–û–ï–ö–¢–ê:\n{context}"

        full_prompt = f"{system_prompt}{regulations_context}{user_context}\n\n‚ùì –í–û–ü–†–û–° –°–ü–ï–¶–ò–ê–õ–ò–°–¢–ê:\n{question}\n\n–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç."

        try:
            # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç Claude API
            if self.claude_client:
                return self._ask_claude(full_prompt)
            elif self.openai_client:
                return self._ask_openai(full_prompt)
            else:
                # –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ –µ—Å–ª–∏ –Ω–µ—Ç API
                demo_answer = self._generate_demo_answer(question, regulations)
                return {
                    "answer": demo_answer,
                    "referenced_regulations": [r['code'] for r in regulations[:3]] if regulations else [],
                    "confidence": 0.5,
                    "model": "demo",
                    "tokens_used": 0
                }

        except Exception as e:
            logger.error(f"Error asking AI: {str(e)}")
            raise

    def _ask_claude(self, prompt: str) -> dict:
        """–ó–∞–ø—Ä–æ—Å –∫ Claude API —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏"""
        response = self.claude_client.messages.create(
            model="claude-3-sonnet-20240229",
            max_tokens=4096,  # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
            temperature=0.7,  # –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å—é –∏ —Ç–æ—á–Ω–æ—Å—Ç—å—é
            messages=[
                {"role": "user", "content": prompt}
            ]
        )

        answer = response.content[0].text

        return {
            "answer": answer,
            "referenced_regulations": self._extract_regulations(answer),
            "confidence": 0.90,  # –ü–æ–≤—ã—à–µ–Ω–Ω–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –¥–ª—è Claude
            "model": "claude-3-sonnet",
            "tokens_used": response.usage.input_tokens + response.usage.output_tokens
        }

    def _ask_openai(self, prompt: str) -> dict:
        """–ó–∞–ø—Ä–æ—Å –∫ OpenAI API —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏"""
        response = self.openai_client.chat.completions.create(
            model="gpt-4-turbo-preview",  # –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å —Å –±–æ–ª—å—à–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
            messages=[
                {"role": "system", "content": "–¢—ã - –≤—ã—Å–æ–∫–æ–∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω—ã–º –Ω–æ—Ä–º–∞—Ç–∏–≤–∞–º –†–æ—Å—Å–∏–∏ —Å 20+ –ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º."},
                {"role": "user", "content": prompt}
            ],
            max_tokens=4096,  # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
            temperature=0.7,
            presence_penalty=0.1,  # –ù–µ–±–æ–ª—å—à–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
            frequency_penalty=0.1
        )

        answer = response.choices[0].message.content

        return {
            "answer": answer,
            "referenced_regulations": self._extract_regulations(answer),
            "confidence": 0.88,
            "model": "gpt-4-turbo",
            "tokens_used": response.usage.total_tokens
        }

    def _extract_regulations(self, text: str) -> List[str]:
        """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–¥–æ–≤ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤ –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
        import re

        # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤
        patterns = [
            r'–°–ü\s+\d+\.[\d\.]+\-\d+',  # –°–ü 63.13330.2018
            r'–°–ü\s+\d+\.[\d\.]+',
            r'–ì–û–°–¢\s+\d+[\-\d]*\-\d+',  # –ì–û–°–¢ 10180-2012
            r'–ì–û–°–¢\s+\d+[\-\d]*',
            r'–°–ù–∏–ü\s+[\d\.]+\-\d+',     # –°–ù–∏–ü 3.03.01-87
            r'–°–ù–∏–ü\s+[\d\.]+',
            r'–°–∞–Ω–ü–∏–ù\s+[\d\.\-]+',
            r'–ü–ë\s+[\d\-]+',            # –ü—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            r'–†–î\s+[\d\-]+',            # –†—É–∫–æ–≤–æ–¥—è—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
        ]

        regulations = []
        for pattern in patterns:
            matches = re.findall(pattern, text)
            regulations.extend(matches)

        return list(set(regulations))  # –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

    def _generate_demo_answer(self, question: str, regulations: Optional[List[dict]] = None) -> str:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–≥–æ –¥–µ–º–æ-–æ—Ç–≤–µ—Ç–∞"""
        reg_list = ""
        if regulations:
            reg_list = "\n".join([f"‚Ä¢ {reg['code']}: {reg['title']}" for reg in regulations[:3]])

        return f"""**–î–ï–ú–û–ù–°–¢–†–ê–¶–ò–û–ù–ù–´–ô –û–¢–í–ï–¢ AI-–ö–û–ù–°–£–õ–¨–¢–ê–ù–¢–ê**

**üìã –í–í–ï–î–ï–ù–ò–ï**

–î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å: "{question}" –Ω–µ–æ–±—Ö–æ–¥–∏–º–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ API –∫–ª—é—á–µ–π OpenAI –∏–ª–∏ Claude.

**üéØ –†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ï –ù–û–†–ú–ê–¢–ò–í–´**

{reg_list if reg_list else "–ù–æ—Ä–º–∞—Ç–∏–≤—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö."}

**‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ê API**

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã—Ö —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã—Ö –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–π:

1. –ü–æ–ª—É—á–∏—Ç–µ API –∫–ª—é—á –æ—Ç OpenAI (https://platform.openai.com/) –∏–ª–∏ Anthropic Claude
2. –î–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á –≤ —Ñ–∞–π–ª .env:
   - OPENAI_API_KEY=your_key_here
   - –∏–ª–∏ CLAUDE_API_KEY=your_key_here
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä

**üí° –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–¨ –ü–û–õ–ù–û–ô –í–ï–†–°–ò–ò**

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API –≤—ã –ø–æ–ª—É—á–∏—Ç–µ:
‚Ä¢ –†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ 300-1000 —Å–ª–æ–≤
‚Ä¢ –¢–æ—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—É–Ω–∫—Ç—ã –Ω–æ—Ä–º–∞—Ç–∏–≤–æ–≤
‚Ä¢ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –ø—Ä–∏–º–µ—Ä—ã
‚Ä¢ –†–∞—Å—á–µ—Ç–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã —Å –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏
‚Ä¢ –¢–∞–±–ª–∏—Ü—ã –∑–Ω–∞—á–µ–Ω–∏–π –∏ –¥–æ–ø—É—Å–∫–æ–≤
‚Ä¢ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç

**üìû –ö–û–ù–¢–ê–ö–¢**

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É –∑–Ω–∞–Ω–∏–π (–¥–æ—Å—Ç—É–ø–Ω–∞ –±–µ–∑ API –∫–ª—é—á–µ–π).
"""


# Singleton instance
ai_service = AIService()
